{
    "schemaVersion": "2.2",
    "description": "Fix Windows Vulnerabilities",
    "mainSteps":
    [
        {
            "action": "aws:runPowerShellScript",
            "name": "disable_insecure_tls_cipher_suites",
            "inputs":
            {
                "runCommand":
                [
                    "try {",
                    "Disable-TlsCipherSuite -Name \"TLS_RSA_WITH_3DES_EDE_CBC_SHA\"",
                    "Disable-TlsCipherSuite -Name \"TLS_RSA_WITH_AES_128_CBC_SHA\"",
                    "Disable-TlsCipherSuite -Name \"TLS_RSA_WITH_RC4_128_MD5\"",
                    "Disable-TlsCipherSuite -Name \"TLS_RSA_WITH_RC4_128_SHA\"",
                    "Disable-TlsCipherSuite -Name \"TLS_RSA_WITH_AES_128_CBC_SHA256\"",
                    "Disable-TlsCipherSuite -Name \"TLS_RSA_WITH_AES_128_GCM_SHA256\"",
                    "Disable-TlsCipherSuite -Name \"TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA\"",
                    "Disable-TlsCipherSuite -Name \"TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA\"",
                    "Disable-TlsCipherSuite -Name \"TLS_DHE_RSA_WITH_AES_256_CBC_SHA\"",
                    "Disable-TlsCipherSuite -Name \"TLS_DHE_RSA_WITH_AES_128_CBC_SHA\"",
                    "Disable-TlsCipherSuite -Name \"TLS_RSA_WITH_AES_256_CBC_SHA\"",
                    "  Write-Host 'Disabled specified TLS cipher suites successfully'",
                    "} catch {",
                    "  Write-Host 'Error occurred while disabling TLS cipher suites'",
                    "}"
                ]
            }
        },
        {
            "action": "aws:runPowerShellScript",
            "name": "harden_iis_configuration",
            "inputs":
            {
                "runCommand":
                [
                    "try {",
                    "  Add-WebConfigurationProperty -Filter system-webServer/security/requestFiltering -Name verbs -Value @{verb='OPTIONS';allowed='False'}",
                    "  Remove-WebConfigurationProperty -Filter /system-webServer/defaultDocument -Name files -AtElement @{value='iisstart.htm'}",
                    "  Write-Host 'IIS configurations hardened successfully'",
                    "} catch {",
                    "  Write-Host 'Error occurred while hardening IIS configurations'",
                    "}"
                ]
            }
        },
        {
            "action": "aws:runPowerShellScript",
            "name": "configure_dns_server",
            "inputs":
            {
                "runCommand":
                [
                    "try {",
                    "  Set-DnsServerRecursion -Enable $false",
                    "  Write-Host 'DNS server recursion disabled successfully'",
                    "} catch {",
                    "  Write-Host 'Error occurred while configuring DNS server'",
                    "}"
                ]
            }
        },
        {
            "action": "aws:runPowerShellScript",
            "name": "enhance_smb_security",
            "inputs":
            {
                "runCommand":
                [
                    "try {",
                    "  Set-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters' -Name 'requiresecuritysignature' -Value 1 -Force",
                    "  Set-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanManServer\\Parameters' -Name 'enablesecuritysignature' -Value 1 -Force",
                    "  Write-Host 'SMB security enhanced successfully'",
                    "} catch {",
                    "  Write-Host 'Error occurred while enhancing SMB security'",
                    "}"
                ]
            }
        },
        {
            "action": "aws:runPowerShellScript",
            "name": "apply_network_firewall_rules",
            "inputs":
            {
                "runCommand":
                [
                    "try {",
                    "  netsh advfirewall firewall add rule name='Block Type 13 ICMP V4' protocol=icmpv4:13,any dir=in action=block",
                    "  netsh advfirewall firewall add rule name='Block Type 14 ICMP V4' protocol=icmpv4:8,any dir=in action=block",
                    "  Write-Host 'Network firewall rules applied successfully'",
                    "} catch {",
                    "  Write-Host 'Error occurred while applying network firewall rules'",
                    "}"
                ]
            }
        },
        {
            "action": "aws:runPowerShellScript",
            "name": "disable_smbv1_protocol",
            "inputs":
            {
                "runCommand":
                [
                    "try {",
                    "  Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -NoRestart",
                    "  Write-Host 'SMBv1 protocol disabled successfully'",
                    "} catch {",
                    "  Write-Host 'Error occurred while disabling SMBv1 protocol'",
                    "}"
                ]
            }
        }
    ]
}