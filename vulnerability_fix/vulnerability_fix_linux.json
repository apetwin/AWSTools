{
  "schemaVersion": "2.2",
  "description": "Fix Linux Vulnerabilities",
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "backup_crypto_policies",
      "inputs": {
        "runCommand": [
          "set -e",
          "ucp=$(update-crypto-policies --show)",
          "backup_dir=~/$(date +%F)_usr_share_crypto-policies",
          "mkdir -p \"$backup_dir\"",
          "cp -r /usr/share/crypto-policies \"$backup_dir\"",
          "echo 'Backup of crypto policies created in $backup_dir'"
        ]
      }
    },
    {
      "action": "aws:runShellScript",
      "name": "modify_crypto_policies",
      "inputs": {
        "runCommand": [
          "set -e",
          "ucp=$(update-crypto-policies --show)",
          "sed -i 's/,hmac-sha1-etm@openssh.com,/,/g; s/,hmac-sha1,/,/g' /usr/share/crypto-policies/${ucp}/libssh.txt",
          "sed -i 's/,hmac-sha1-etm@openssh.com,/,/g; s/,hmac-sha1,/,/g' /usr/share/crypto-policies/${ucp}/openssh.txt",
          "sed -i 's/,hmac-sha1-etm@openssh.com,/,/g; s/,hmac-sha1,/,/g' /usr/share/crypto-policies/${ucp}/opensshserver.txt",
          "sed -i 's/,hmac-sha1-etm@openssh.com,/,/g; s/,hmac-sha1,/,/g' /usr/share/crypto-policies/back-ends/${ucp}/libssh.config",
          "sed -i 's/,hmac-sha1-etm@openssh.com,/,/g; s/,hmac-sha1,/,/g' /usr/share/crypto-policies/back-ends/${ucp}/openssh.config",
          "sed -i 's/,hmac-sha1-etm@openssh.com,/,/g; s/,hmac-sha1,/,/g' /usr/share/crypto-policies/back-ends/${ucp}/opensshserver.config",
          "echo 'Crypto policies modified for hmac-sha1 vulnerabilities'"
        ]
      }
    },
    {
      "action": "aws:runShellScript",
      "name": "restart_ssh_service",
      "inputs": {
        "runCommand": [
          "set -e",
          "sshd -t",
          "systemctl restart sshd",
          "systemctl status sshd",
          "echo 'SSH service restarted successfully'"
        ]
      }
    },
    {
      "action": "aws:runShellScript",
      "name": "apply_iptables_rules",
      "inputs": {
        "runCommand": [
          "set -e",
          "iptables -A INPUT -p icmp --icmp-type timestamp-request -j DROP",
          "iptables -A OUTPUT -p icmp --icmp-type timestamp-reply -j DROP",
          "echo 'IPTables rules applied to block certain ICMP types'"
        ]
      }
    }
  ]
}
